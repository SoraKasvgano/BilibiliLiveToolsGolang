<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>素材库</title>
  <link rel="stylesheet" href="/app/pages/shared.css" />
</head>
<body>
  <header class="shared-header">
    <div id="sharedNav"></div>
  </header>
  <main class="page-shell">
    <section class="page-card">
      <h1>素材库</h1>
      <p class="soft-note">上传后可在推流与拼屏中直接复用，无需每次手动选本地文件。</p>
      <div id="roleTip" class="role-tip"></div>
      <label>选择素材文件
        <input id="files" type="file" multiple />
      </label>
      <div class="actions">
        <button id="upload" data-perm="operator,admin">上传素材</button>
        <button id="list">刷新列表</button>
      </div>
      <div class="upload-progress">
        <div class="progress-bar"><span id="uploadProgressValue" class="progress-value"></span></div>
        <div id="uploadProgressText" class="soft-note">等待上传...</div>
      </div>
    </section>

    <section class="page-card">
      <h2>素材列表</h2>
      <div class="table-wrap">
        <table id="materialTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>文件名</th>
              <th>类型</th>
              <th>大小</th>
              <th>存储路径</th>
              <th>创建时间</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="materialEmpty" class="empty-hint" style="display:none;">暂无素材，先上传一个视频试试吧。</div>
      <pre id="box">[]</pre>
    </section>
  </main>

  <script src="/app/pages/shared.js"></script>
  <script>
    const { initPage, requestJSON, showJSON, bindAction } = window.GoverShared;
    initPage({ active: "material" });

    function setProgress(percent, text) {
      const value = Math.max(0, Math.min(100, Number(percent || 0)));
      document.getElementById("uploadProgressValue").style.width = `${value}%`;
      document.getElementById("uploadProgressText").textContent = text || "等待上传...";
    }

    function renderMaterials(pageResult) {
      const raw = (pageResult || {});
      const rows = Array.isArray(raw) ? raw : (Array.isArray(raw.data) ? raw.data : []);
      const body = document.querySelector("#materialTable tbody");
      body.innerHTML = "";
      if (!rows.length) {
        document.getElementById("materialEmpty").style.display = "";
        return;
      }
      document.getElementById("materialEmpty").style.display = "none";
      for (const item of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.id || ""}</td>
          <td>${item.name || ""}</td>
          <td>${item.fileType || ""}</td>
          <td>${item.size || ""}</td>
          <td title="${item.fullPath || ""}">${item.path || ""}</td>
          <td>${item.createdTime || ""}</td>
        `;
        body.appendChild(tr);
      }
    }

    async function listMaterials() {
      const result = await requestJSON("/api/v1/materials?page=1&limit=100");
      renderMaterials(result.data || {});
      showJSON("box", result);
      return result;
    }

    function uploadWithProgress(formData) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/v1/materials/upload", true);
        xhr.upload.onprogress = (event) => {
          if (!event.lengthComputable) {
            setProgress(100, "上传中...");
            return;
          }
          const percent = Math.round((event.loaded / event.total) * 100);
          setProgress(percent, `上传中... ${percent}%`);
        };
        xhr.onload = () => {
          if (xhr.status < 200 || xhr.status >= 300) {
            reject(new Error(`HTTP ${xhr.status}: ${xhr.responseText || "upload failed"}`));
            return;
          }
          try {
            const payload = JSON.parse(xhr.responseText || "{}");
            resolve(payload);
          } catch {
            reject(new Error(xhr.responseText || "上传响应解析失败"));
          }
        };
        xhr.onerror = () => reject(new Error("网络错误：上传失败"));
        xhr.send(formData);
      });
    }

    bindAction("upload", async () => {
      const files = document.getElementById("files").files;
      if (!files || files.length === 0) throw new Error("请先选择文件");
      const form = new FormData();
      for (const file of files) form.append("file", file);
      setProgress(5, "上传中...");
      const result = await uploadWithProgress(form);
      setProgress(100, "上传完成");
      showJSON("box", result);
      await listMaterials();
      return result;
    }, "box");
    bindAction("list", listMaterials, "box", { successToast: false });

    setProgress(0, "等待上传...");
    listMaterials().catch((error) => showJSON("box", { code: -1, message: error.message || String(error) }));
  </script>
</body>
</html>
