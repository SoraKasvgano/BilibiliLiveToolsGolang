<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>扫码登录</title>
  <link rel="stylesheet" href="/app/pages/shared.css" />
</head>
<body>
  <header class="shared-header">
    <div id="sharedNav"></div>
  </header>
  <main class="page-shell">
    <section class="page-card">
      <h1>扫码登录</h1>
      <p class="soft-note">请用手机 Bilibili App 扫描二维码登录。登录成功后会自动同步 Cookie。</p>
      <div id="roleTip" class="role-tip"></div>

      <div class="status-line">
        <strong>登录状态:</strong>
        <span id="loginStatusBadge" class="badge badge-neutral">加载中</span>
      </div>

      <div class="preview-panel" style="text-align:center;">
        <img id="qrImage" alt="登录二维码" style="display:none;max-width:340px;margin:0 auto;" />
        <div id="qrPlaceholder" class="empty-hint">点击“生成二维码”开始扫码登录。</div>
        <div style="margin-top:10px;">
          <div class="progress-bar">
            <span id="qrProgressValue" class="progress-value" style="width:0%;"></span>
          </div>
          <div id="qrProgressText" class="soft-note">等待二维码生成...</div>
        </div>
      </div>

      <div class="actions">
        <button id="btnGenerateQr" class="btn-success">生成二维码</button>
        <button id="btnRefreshStatus">刷新状态</button>
        <button id="btnOpenHome" class="btn-ghost">返回功能首页</button>
      </div>
      <pre id="loginBox">{}</pre>
    </section>
  </main>

  <script src="/app/pages/shared.js"></script>
  <script>
    const {
      initPage,
      requestJSON,
      showJSON,
      bindAction,
      statusBadge,
      showToast,
      createPoller
    } = window.GoverShared;
    initPage({ active: "login" });

    const popupParams = new URLSearchParams(window.location.search);
    const autoCloseEnabled = popupParams.get("autoclose") === "1";
    let qrMaxAge = 180;
    let loginCompleted = false;

    function setStatusBadge(text, type) {
      const old = document.getElementById("loginStatusBadge");
      if (!old) return;
      old.outerHTML = statusBadge(text, type).replace("<span", '<span id="loginStatusBadge"');
    }

    function setProgress(effectiveTime) {
      const ttl = Number(effectiveTime || 0);
      const pct = qrMaxAge > 0 ? Math.max(0, Math.min(100, Math.round((ttl / qrMaxAge) * 100))) : 0;
      document.getElementById("qrProgressValue").style.width = `${pct}%`;
      document.getElementById("qrProgressText").textContent = ttl > 0 ? `二维码剩余有效期 ${ttl} 秒` : "二维码已失效，请重新生成";
    }

    function showQRCode(imageBase64) {
      const img = document.getElementById("qrImage");
      const hint = document.getElementById("qrPlaceholder");
      if (!imageBase64) {
        img.style.display = "none";
        img.src = "";
        hint.style.display = "";
        return;
      }
      img.src = imageBase64;
      img.style.display = "block";
      hint.style.display = "none";
    }

    function notifyLoginSuccess(data) {
      if (!window.opener || window.opener.closed) return;
      try {
        window.opener.postMessage({
          type: "gover-login-success",
          payload: data || {}
        }, "*");
      } catch (error) {
        console.warn("postMessage failed", error);
      }
    }

    function tryCloseWindow() {
      try {
        window.close();
      } catch (error) {
        console.warn("window.close failed", error);
      }
      return !!window.closed;
    }

    function handleLoginSuccess(data) {
      if (loginCompleted) return;
      loginCompleted = true;
      setStatusBadge("已登录", "success");
      setProgress(0);
      showToast("扫码登录成功，Cookie 已同步", "success");
      notifyLoginSuccess(data || {});
      if (autoCloseEnabled || (window.opener && !window.opener.closed)) {
        setTimeout(() => {
          if (!tryCloseWindow()) {
            window.location.replace("/app/pages/home.html");
          }
        }, 600);
      }
    }

    function renderStatusPayload(payload) {
      const data = payload || {};
      const status = Number(data.status || 0);
      const qr = data.qrCodeStatus || {};
      if (status === 3 || qr.isLogged) {
        showQRCode("");
        handleLoginSuccess(data);
        return;
      }
      if (status === 1) {
        setStatusBadge("未登录", "danger");
        setProgress(0);
        showQRCode("");
        return;
      }
      if (status === 4) {
        setStatusBadge("加载中", "info");
        return;
      }
      if (status === 2 || qr.qrCode) {
        if (qr.qrCode) {
          showQRCode(qr.qrCode);
        }
        const ttl = Number(qr.qrCodeEffectiveTime || 0);
        if (ttl > qrMaxAge) qrMaxAge = ttl;
        if (ttl <= 0) {
          setStatusBadge("二维码失效", "neutral");
          setProgress(0);
          return;
        }
        setProgress(ttl);
        if (qr.isScaned) {
          setStatusBadge("已扫码", "success");
        } else {
          setStatusBadge("等待扫码", "danger");
        }
        return;
      }
      setStatusBadge("未知状态", "warning");
    }

    async function generateQRCode() {
      loginCompleted = false;
      const result = await requestJSON("/api/v1/account/login/qrcode/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: "{}"
      });
      showJSON("loginBox", result);
      renderStatusPayload({ status: 2, qrCodeStatus: result.data || {} });
      return result;
    }

    async function refreshStatus() {
      const result = await requestJSON("/api/v1/account/status");
      showJSON("loginBox", result);
      renderStatusPayload(result.data || {});
      return result;
    }

    bindAction("btnGenerateQr", generateQRCode, "loginBox");
    bindAction("btnRefreshStatus", refreshStatus, "loginBox", { successToast: false });
    bindAction("btnOpenHome", async () => {
      window.location.href = "/app/pages/home.html";
      return { code: 0, message: "正在返回功能首页..." };
    }, "loginBox");

    const poller = createPoller(refreshStatus, 1200);
    poller.start();
    generateQRCode().catch((error) => {
      showJSON("loginBox", { code: -1, message: error.message || String(error) });
      setStatusBadge("生成失败", "danger");
    });
  </script>
</body>
</html>
