<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>推流配置</title>
  <link rel="stylesheet" href="/app/pages/shared.css" />
</head>
<body>
  <header class="shared-header">
    <div id="sharedNav"></div>
  </header>
  <main class="page-shell">
    <section class="page-card">
      <h1>推流配置</h1>
      <p class="soft-note">推荐流程：先在摄像头管理页保存设备，然后在这里一键套用，减少手动输入错误。</p>
      <div id="roleTip" class="role-tip"></div>
      <div class="status-line">
        <strong>当前推流状态:</strong>
        <span id="pushStatusBadge" class="badge badge-neutral">检查中</span>
        <span id="pushStatusText" class="soft-note">系统正在读取最新状态...</span>
      </div>
    </section>

    <section class="page-card">
      <h2>快速套用（来自摄像头库）</h2>
      <div class="grid two">
        <label>类型筛选
          <select id="cameraFilterType">
            <option value="">全部</option>
            <option value="rtsp">RTSP</option>
            <option value="mjpeg">MJPEG</option>
            <option value="onvif">ONVIF</option>
            <option value="usb">USB</option>
          </select>
        </label>
        <label>选择摄像头
          <select id="cameraSelect">
            <option value="">（请先刷新列表）</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button id="btnLoadCameras">刷新摄像头列表</button>
        <button id="btnApplyCamera">一键套用并保存</button>
        <button id="btnOpenCameraPage">打开摄像头管理页</button>
      </div>
    </section>

    <section class="page-card">
      <h2>基础推流参数</h2>
      <div class="grid two">
        <label>模式
          <select id="model">
            <option value="1">普通模式</option>
            <option value="2">高级模式</option>
          </select>
        </label>
        <label>输入类型
          <select id="inputType">
            <option value="video">视频文件</option>
            <option value="usb_camera">USB 摄像头</option>
            <option value="desktop">桌面</option>
            <option value="rtsp">RTSP</option>
            <option value="mjpeg">MJPEG</option>
            <option value="onvif">ONVIF</option>
          </select>
        </label>
      </div>
      <div class="grid two">
        <label>输出分辨率<input id="resolution" value="1280x720" /></label>
        <label>输出质量
          <select id="quality">
            <option value="1">高</option>
            <option value="2" selected>中</option>
            <option value="3">低</option>
            <option value="9">原画</option>
          </select>
        </label>
      </div>
      <div class="grid two">
        <label>推流码率预设
          <select id="bitratePreset">
            <option value="auto" selected>自动（跟随质量档位）</option>
            <option value="2000">流畅 2M - 适合手机观看</option>
            <option value="3500">标准 3.5M - 日常推荐</option>
            <option value="5000">高清 5M - 画质优先</option>
            <option value="8000">超清 8M - 高速网络</option>
            <option value="12000">蓝光 12M - 极高画质</option>
            <option value="custom">自定义</option>
          </select>
        </label>
        <label id="bitrateCustomWrap" style="display:none;">自定义码率（kbps）
          <input id="bitrateCustom" type="number" value="4500" min="500" max="120000" />
        </label>
      </div>
      <p class="soft-note">建议先用 3500~5000 kbps；网络不稳时可降到 2000 kbps，避免观众端缓冲卡顿。</p>
      <div class="grid two">
        <label>自动重试
          <select id="autoRetry">
            <option value="true" selected>开启</option>
            <option value="false">关闭</option>
          </select>
        </label>
        <label>重试间隔（秒）<input id="retryInterval" type="number" value="30" /></label>
      </div>
    </section>

    <section class="page-card">
      <h2>输入源详情</h2>
      <div id="panelRTSP" class="soft-panel panel-hidden">
        <h3>RTSP</h3>
        <label>RTSP URL<input id="rtspUrl" placeholder="rtsp://user:pass@ip/stream" /></label>
      </div>
      <div id="panelMJPEG" class="soft-panel panel-hidden">
        <h3>MJPEG</h3>
        <label>MJPEG URL<input id="mjpegUrl" placeholder="http://ip:port/mjpeg" /></label>
      </div>
      <div id="panelONVIF" class="soft-panel panel-hidden">
        <h3>ONVIF（明文用户名/密码）</h3>
        <div class="grid two">
          <label>Endpoint<input id="onvifEndpoint" placeholder="http://ip/onvif/device_service" /></label>
          <label>ProfileToken<input id="onvifProfileToken" placeholder="可选" /></label>
        </div>
        <div class="grid two">
          <label>用户名<input id="onvifUsername" placeholder="admin" /></label>
          <label>密码<input id="onvifPassword" type="text" placeholder="123456" /></label>
        </div>
        <label>绑定 RTSP URL<input id="onvifRtspUrl" placeholder="rtsp://user:pass@ip/stream" /></label>
      </div>
      <div id="panelUSB" class="soft-panel panel-hidden">
        <h3>USB 摄像头</h3>
        <div class="grid two">
          <label>设备名称<input id="usbName" placeholder="HD Pro Webcam C920 或 /dev/video0" /></label>
          <label>分辨率<input id="usbResolution" value="1280x720" /></label>
        </div>
        <label>帧率（fps）<input id="usbFramerate" type="number" value="30" /></label>
      </div>
      <label>高级模式 FFmpeg 命令（必须包含 {URL}）
        <textarea id="ffmpegCommand" rows="3" placeholder="ffmpeg ... -f flv {URL}"></textarea>
      </label>
      <div class="actions">
        <button id="btnFillAdvancedCmd">按输入类型填充推荐命令</button>
      </div>
      <p class="soft-note">提示：高级模式命令是“手动托管”，切换输入源不会自动强改你已编辑的命令；可点击上方按钮快速生成模板。</p>

      <div class="soft-panel">
        <h3>本地预览（调试画面，不会推到平台）</h3>
        <p class="soft-note">建议先在这里确认摄像头/地址有效，再点击“开始推流”。关闭预览会立即释放资源。</p>
        <div class="grid two">
          <label>预览宽度（px）
            <input id="previewWidth" type="number" value="960" min="240" max="1920" />
          </label>
          <label>预览帧率（fps）
            <input id="previewFps" type="number" value="10" min="1" max="20" />
          </label>
        </div>
        <div class="actions">
          <button id="btnStartLocalPreview">开启本地预览</button>
          <button id="btnStopLocalPreview">关闭本地预览</button>
        </div>
        <div class="preview-panel">
          <img id="localPreviewImage" alt="推流本地预览画面" />
          <div id="localPreviewInfo" class="soft-note">本地预览默认关闭，点击“开启本地预览”后按当前配置拉流并显示。</div>
        </div>
      </div>
    </section>

    <section class="page-card">
      <h2>执行操作</h2>
      <h3>配置操作</h3>
      <div class="actions">
        <button id="load">读取配置</button>
        <button id="save" data-perm="operator,admin">保存配置</button>
      </div>
      <h3>推流控制</h3>
      <div class="actions">
        <button id="start" class="btn-success btn-lg" data-perm="operator,admin">开始推流</button>
        <button id="stop" class="btn-danger btn-lg" data-perm="operator,admin">停止推流</button>
        <button id="restart" class="btn-warning btn-lg" data-perm="operator,admin">重启推流</button>
        <button id="status">读取状态</button>
      </div>
      <div class="soft-note">状态每 5 秒自动刷新，你也可以手动点击“读取状态”。</div>
      <div class="actions">
        <button id="btnOpenAdvancedConsole" class="btn-ghost">打开高级控制台</button>
      </div>
      <pre id="box">{}</pre>
    </section>
  </main>

  <script src="/app/pages/shared.js"></script>
  <script>
    const { initPage, requestJSON, showJSON, bindAction, showToast, markFields, statusBadge, createPoller, setPanelVisible } = window.GoverShared;
    initPage({ active: "push" });

    const cameraMap = new Map();
    let localPreviewRunning = false;

    function asText(id) {
      return String(document.getElementById(id).value || "").trim();
    }

    function asNumber(id, fallback) {
      const value = Number(document.getElementById(id).value || 0);
      return Number.isFinite(value) ? value : fallback;
    }

    function asBool(id) {
      return String(document.getElementById(id).value || "").toLowerCase() === "true";
    }

    function normalizeBitrateKbps(value) {
      const num = Number(value || 0);
      if (!Number.isFinite(num) || num <= 0) return 0;
      if (num > 120000) return 120000;
      return Math.round(num);
    }

    function syncBitrateCustomVisibility() {
      const preset = asText("bitratePreset");
      const wrap = document.getElementById("bitrateCustomWrap");
      wrap.style.display = preset === "custom" ? "" : "none";
    }

    function applyBitratePresetFromValue(value) {
      const normalized = normalizeBitrateKbps(value);
      const presetEl = document.getElementById("bitratePreset");
      const customEl = document.getElementById("bitrateCustom");
      if (!normalized) {
        presetEl.value = "auto";
      } else if (["2000", "3500", "5000", "8000", "12000"].includes(String(normalized))) {
        presetEl.value = String(normalized);
      } else {
        presetEl.value = "custom";
        customEl.value = String(normalized);
      }
      if (!customEl.value) {
        customEl.value = "4500";
      }
      syncBitrateCustomVisibility();
    }

    function currentBitrateKbps() {
      const preset = asText("bitratePreset");
      if (preset === "auto") return 0;
      if (preset === "custom") {
        return normalizeBitrateKbps(asNumber("bitrateCustom", 4500));
      }
      return normalizeBitrateKbps(preset);
    }

    function setPushStatusView(statusValue) {
      const status = Number(statusValue || 0);
      let text = "已停止";
      let type = "neutral";
      let detail = "推流进程当前未运行。";
      if (status === 3) {
        text = "运行中";
        type = "success";
        detail = "推流正常进行中。";
      } else if (status === 1) {
        text = "启动中";
        type = "warning";
        detail = "正在启动 FFmpeg 推流进程。";
      } else if (status === 4) {
        text = "重试中";
        type = "warning";
        detail = "推流失败后等待自动重试。";
      }
      const old = document.getElementById("pushStatusBadge");
      if (old) {
        old.outerHTML = statusBadge(text, type).replace("<span", '<span id="pushStatusBadge"');
      }
      document.getElementById("pushStatusText").textContent = detail;
    }

    function setLocalPreviewInfo(text) {
      document.getElementById("localPreviewInfo").textContent = text || "";
    }

    function stopLocalPreview() {
      const img = document.getElementById("localPreviewImage");
      localPreviewRunning = false;
      img.style.display = "none";
      img.src = "";
      setLocalPreviewInfo("本地预览已关闭。");
    }

    function switchInputPanels() {
      const inputType = asText("inputType");
      setPanelVisible("panelRTSP", inputType === "rtsp");
      setPanelVisible("panelMJPEG", inputType === "mjpeg");
      setPanelVisible("panelONVIF", inputType === "onvif");
      setPanelVisible("panelUSB", inputType === "usb_camera" || inputType === "usb_camera_plus");
    }

    function isUsbTemplateCommand(commandText) {
      const lower = String(commandText || "").toLowerCase();
      return lower.includes("-f dshow") || lower.includes("video=\"") || lower.includes("-f v4l2") || lower.includes("/dev/video");
    }

    function recommendedAdvancedCommand(inputType) {
      const type = String(inputType || "").toLowerCase();
      const commonOut = "-vcodec libx264 -pix_fmt yuv420p -r 25 -g 50 -b:v 3500k -maxrate 3500k -bufsize 7000k -preset veryfast -tune zerolatency -f flv {URL}";
      if (type === "rtsp" || type === "onvif") {
        return `ffmpeg -rtsp_transport tcp -i \"${type === "onvif" ? "rtsp://user:pass@ip/stream" : "rtsp://user:pass@ip/stream"}\" -an ${commonOut}`;
      }
      if (type === "mjpeg") {
        return "ffmpeg -f mjpeg -i \"http://ip:port/mjpeg\" -an " + commonOut;
      }
      if (type === "usb_camera" || type === "usb_camera_plus") {
        return "ffmpeg -f dshow -video_size 1280x720 -framerate 30 -i video=\"HD Pro Webcam C920\" -an " + commonOut;
      }
      return "ffmpeg -re -i \"input.mp4\" -an " + commonOut;
    }

    function autoSuggestAdvancedCommand() {
      const model = asNumber("model", 1);
      if (model !== 2) return;
      const inputType = asText("inputType");
      const commandEl = document.getElementById("ffmpegCommand");
      const current = commandEl.value || "";
      if (!current.trim()) {
        commandEl.value = recommendedAdvancedCommand(inputType);
        return;
      }
      const networkType = inputType === "rtsp" || inputType === "mjpeg" || inputType === "onvif";
      if (networkType && isUsbTemplateCommand(current)) {
        commandEl.value = recommendedAdvancedCommand(inputType);
      }
    }

    function cameraTypeLabel(type) {
      const value = String(type || "").toLowerCase();
      if (value === "rtsp") return "RTSP";
      if (value === "mjpeg") return "MJPEG";
      if (value === "onvif") return "ONVIF";
      if (value === "usb") return "USB";
      return value || "unknown";
    }

    function cameraHint(item) {
      if (!item) return "";
      const type = String(item.sourceType || "").toLowerCase();
      if (type === "rtsp" || type === "onvif") return item.rtspUrl || item.onvifEndpoint || "";
      if (type === "mjpeg") return item.mjpegUrl || "";
      if (type === "usb") return item.usbDeviceName || "";
      return "";
    }

    function fillByCamera(item) {
      if (!item) return;
      const type = String(item.sourceType || "").toLowerCase();
      if (type === "rtsp") {
        document.getElementById("inputType").value = "rtsp";
        document.getElementById("rtspUrl").value = item.rtspUrl || "";
      } else if (type === "mjpeg") {
        document.getElementById("inputType").value = "mjpeg";
        document.getElementById("mjpegUrl").value = item.mjpegUrl || "";
      } else if (type === "onvif") {
        document.getElementById("inputType").value = "onvif";
        document.getElementById("onvifEndpoint").value = item.onvifEndpoint || "";
        document.getElementById("onvifUsername").value = item.onvifUsername || "";
        document.getElementById("onvifPassword").value = item.onvifPassword || "";
        document.getElementById("onvifProfileToken").value = item.onvifProfileToken || "";
        document.getElementById("onvifRtspUrl").value = item.rtspUrl || "";
      } else if (type === "usb") {
        document.getElementById("inputType").value = "usb_camera";
        document.getElementById("usbName").value = item.usbDeviceName || "";
        document.getElementById("usbResolution").value = item.usbDeviceResolution || "1280x720";
        document.getElementById("usbFramerate").value = String(item.usbDeviceFramerate || 30);
      }
      switchInputPanels();
    }

    async function loadCameras() {
      const params = new URLSearchParams();
      params.set("page", "1");
      params.set("limit", "200");
      const filterType = asText("cameraFilterType");
      if (filterType) params.set("sourceType", filterType);
      const result = await requestJSON(`/api/v1/cameras?${params.toString()}`);
      showJSON("box", result);
      const select = document.getElementById("cameraSelect");
      select.innerHTML = '<option value="">（请选择已保存摄像头）</option>';
      cameraMap.clear();
      const items = ((result || {}).data || {}).data || [];
      for (const item of items) {
        cameraMap.set(item.id, item);
        const option = document.createElement("option");
        option.value = String(item.id);
        option.textContent = `${item.name || `Camera-${item.id}`} [${cameraTypeLabel(item.sourceType)}] ${cameraHint(item)}`;
        select.appendChild(option);
      }
    }

    async function applySelectedCamera() {
      const id = Number(document.getElementById("cameraSelect").value || 0);
      if (!id) throw new Error("请先选择摄像头");
      const result = await requestJSON(`/api/v1/cameras/${id}/apply-push`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: "{}"
      });
      showJSON("box", result);
      if (result && result.data && result.data.pushSetting) {
        fillSetting(result.data.pushSetting);
        markFields([
          "inputType",
          "rtspUrl",
          "mjpegUrl",
          "onvifEndpoint",
          "onvifUsername",
          "onvifPassword",
          "onvifProfileToken",
          "onvifRtspUrl",
          "usbName",
          "usbResolution",
          "usbFramerate",
        ]);
        showToast("摄像头已套用到推流配置", "success");
      }
    }

    function fillSetting(item) {
      const data = item || {};
      document.getElementById("model").value = String(data.model || 1);
      document.getElementById("inputType").value = data.inputType || "video";
      document.getElementById("resolution").value = data.outputResolution || "1280x720";
      document.getElementById("quality").value = String(data.outputQuality || 2);
      applyBitratePresetFromValue(data.outputBitrateKbps || 0);
      document.getElementById("autoRetry").value = data.isAutoRetry ? "true" : "false";
      document.getElementById("retryInterval").value = String(data.retryInterval || 30);
      document.getElementById("ffmpegCommand").value = data.ffmpegCommand || "";
      document.getElementById("rtspUrl").value = data.rtspUrl || "";
      document.getElementById("mjpegUrl").value = data.mjpegUrl || "";
      document.getElementById("onvifEndpoint").value = data.onvifEndpoint || "";
      document.getElementById("onvifUsername").value = data.onvifUsername || "";
      document.getElementById("onvifPassword").value = data.onvifPassword || "";
      document.getElementById("onvifProfileToken").value = data.onvifProfileToken || "";
      document.getElementById("onvifRtspUrl").value = data.rtspUrl || "";
      document.getElementById("usbName").value = data.inputDeviceName || "";
      document.getElementById("usbResolution").value = data.inputDeviceResolution || "1280x720";
      document.getElementById("usbFramerate").value = String(data.inputDeviceFramerate || 30);
      switchInputPanels();
      autoSuggestAdvancedCommand();
    }

    async function loadSetting() {
      const result = await requestJSON("/api/v1/push/setting");
      fillSetting(result.data || {});
      showJSON("box", result);
      await refreshPushStatus(true);
    }

    function buildPayload() {
      const inputType = asText("inputType") || "video";
      const payload = {
        model: asNumber("model", 1),
        inputType,
        outputResolution: asText("resolution") || "1280x720",
        outputQuality: asNumber("quality", 2),
        outputBitrateKbps: currentBitrateKbps(),
        isAutoRetry: asBool("autoRetry"),
        retryInterval: asNumber("retryInterval", 30),
        ffmpegCommand: document.getElementById("ffmpegCommand").value || "",
        rtspUrl: asText("rtspUrl"),
        mjpegUrl: asText("mjpegUrl"),
        onvifEndpoint: asText("onvifEndpoint"),
        onvifUsername: asText("onvifUsername"),
        onvifPassword: document.getElementById("onvifPassword").value || "",
        onvifProfileToken: asText("onvifProfileToken"),
        inputDeviceName: asText("usbName"),
        inputDeviceResolution: asText("usbResolution"),
        inputDeviceFramerate: asNumber("usbFramerate", 30)
      };
      if (inputType === "onvif") {
        payload.rtspUrl = asText("onvifRtspUrl");
      }
      return payload;
    }

    async function saveSetting() {
      const result = await requestJSON("/api/v1/push/setting", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(buildPayload())
      });
      showJSON("box", result);
    }

    async function startLocalPreview() {
      const saveResult = await requestJSON("/api/v1/push/setting", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(buildPayload())
      });
      showJSON("box", saveResult);
      if (saveResult && Number(saveResult.code) < 0) {
        throw new Error(saveResult.message || "保存推流配置失败，无法开启本地预览");
      }
      const width = Math.max(240, Math.min(1920, asNumber("previewWidth", 960)));
      const fps = Math.max(1, Math.min(20, asNumber("previewFps", 10)));
      const img = document.getElementById("localPreviewImage");
      localPreviewRunning = true;
      img.style.display = "block";
      img.onerror = () => {
        if (!localPreviewRunning) return;
        setLocalPreviewInfo("本地预览连接失败，请检查输入源信息后重试。");
      };
      img.onload = () => {
        if (!localPreviewRunning) return;
        setLocalPreviewInfo("本地预览进行中（低帧率用于调试，降低资源占用）");
      };
      img.src = `/api/v1/push/preview/mjpeg?width=${width}&fps=${fps}&_ts=${Date.now()}`;
      setLocalPreviewInfo("正在建立本地预览连接...");
    }

    async function refreshPushStatus(quiet) {
      const result = await requestJSON("/api/v1/push/status");
      if (!quiet) {
        showJSON("box", result);
      }
      setPushStatusView(result && result.data ? result.data.status : 0);
      return result;
    }

    document.getElementById("inputType").onchange = () => {
      switchInputPanels();
      autoSuggestAdvancedCommand();
    };
    document.getElementById("model").onchange = autoSuggestAdvancedCommand;
    document.getElementById("bitratePreset").onchange = syncBitrateCustomVisibility;
    document.getElementById("cameraFilterType").onchange = () => loadCameras().catch((error) => showJSON("box", { code: -1, message: error.message || String(error) }));

    bindAction("load", loadSetting, "box", { successToast: false });
    bindAction("save", saveSetting, "box");
    bindAction("start", async () => {
      const result = await requestJSON("/api/v1/push/start", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
      showJSON("box", result);
      await refreshPushStatus(true);
      return result;
    }, "box");
    bindAction("stop", async () => {
      const result = await requestJSON("/api/v1/push/stop", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
      showJSON("box", result);
      await refreshPushStatus(true);
      return result;
    }, "box");
    bindAction("restart", async () => {
      const result = await requestJSON("/api/v1/push/restart", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
      showJSON("box", result);
      await refreshPushStatus(true);
      return result;
    }, "box");
    bindAction("status", () => refreshPushStatus(false), "box", { successToast: false });
    bindAction("btnLoadCameras", loadCameras, "box", { successToast: false });
    bindAction("btnApplyCamera", applySelectedCamera, "box");
    bindAction("btnOpenCameraPage", async () => {
      window.location.href = "/app/pages/cameras.html";
    }, "box");
    bindAction("btnFillAdvancedCmd", async () => {
      document.getElementById("ffmpegCommand").value = recommendedAdvancedCommand(asText("inputType"));
      showJSON("box", { code: 0, message: "已按当前输入类型填充推荐高级命令" });
    }, "box");
    bindAction("btnStartLocalPreview", startLocalPreview, "box");
    bindAction("btnStopLocalPreview", async () => {
      stopLocalPreview();
      showJSON("box", { code: 0, message: "已关闭本地预览" });
    }, "box");
    bindAction("btnOpenAdvancedConsole", async () => {
      window.open("/app/index.html", "_blank", "noopener");
      return { code: 0, message: "已打开高级控制台" };
    }, "box");

    switchInputPanels();
    applyBitratePresetFromValue(0);
    stopLocalPreview();
    loadSetting().catch((error) => showJSON("box", { code: -1, message: error.message || String(error) }));
    loadCameras().catch((error) => showJSON("box", { code: -1, message: error.message || String(error) }));
    const statusPoller = createPoller(() => refreshPushStatus(true), 5000);
    statusPoller.start();
  </script>
</body>
</html>
