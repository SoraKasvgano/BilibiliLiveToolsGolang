<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>监控与通知</title>
  <link rel="stylesheet" href="/app/pages/shared.css" />
</head>
<body>
  <header class="shared-header">
    <div id="sharedNav"></div>
  </header>
  <main class="page-shell">
    <section class="page-card">
      <h1>监控与通知</h1>
      <p class="soft-note">分成两块设置：房间监控配置 + 邮件通知配置，便于普通用户理解。</p>
      <div id="roleTip" class="role-tip"></div>
    </section>

    <section class="page-card">
      <h2>房间监控</h2>
      <div class="grid two">
        <label>启用监控
          <select id="isEnabled">
            <option value="true">开启</option>
            <option value="false">关闭</option>
          </select>
        </label>
        <label>房间号<input id="roomId" type="number" /></label>
      </div>
      <label>房间URL<input id="roomUrl" /></label>
      <div class="actions">
        <button id="load">读取配置</button>
        <button id="saveRoom" data-perm="operator,admin">保存房间监控</button>
      </div>
    </section>

    <section class="page-card">
      <h2>邮件通知</h2>
      <div class="grid two">
        <label>SMTP服务器<input id="smtpServer" /></label>
        <label>SMTP端口<input id="smtpPort" type="number" value="25" /></label>
      </div>
      <div class="grid two">
        <label>发件邮箱<input id="mailAddress" /></label>
        <label>发件人名称<input id="mailName" /></label>
      </div>
      <div class="grid two">
        <label>密码<input id="password" type="password" /></label>
        <label>收件人(分号分隔)<input id="receivers" /></label>
      </div>
      <div class="grid two">
        <label>SSL
          <select id="smtpSsl">
            <option value="false">关闭</option>
            <option value="true">开启</option>
          </select>
        </label>
        <label>启用邮件通知
          <select id="emailEnabled">
            <option value="false">关闭</option>
            <option value="true">开启</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button id="saveEmail" data-perm="operator,admin">保存邮件配置</button>
        <button id="testEmail" class="btn-warning" data-perm="operator,admin">发送测试邮件</button>
      </div>
      <div class="grid two">
        <label>测试邮件标题<input id="testSubject" value="[Gover] Monitor test email" /></label>
        <label>状态日志级别
          <select id="statusLevel">
            <option value="">全部</option>
            <option value="INFO">INFO</option>
            <option value="WARN">WARN</option>
            <option value="ERROR">ERROR</option>
          </select>
        </label>
      </div>
      <label>测试邮件正文<textarea id="testBody" rows="3">This is a monitor test email from Gover.</textarea></label>
      <label>状态日志条数<input id="statusLimit" type="number" value="100" /></label>
      <div class="actions">
        <button id="status">读取状态日志</button>
      </div>
    </section>

    <section class="page-card">
      <h2>运行日志</h2>
      <div class="table-wrap">
        <table id="monitorLogTable">
          <thead>
            <tr>
              <th>级别</th>
              <th>时间</th>
              <th>消息</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="monitorLogEmpty" class="empty-hint" style="display:none;">暂无运行日志，执行一次“发送测试邮件”后会出现日志。</div>
      <pre id="box">{}</pre>
    </section>
  </main>

  <script src="/app/pages/shared.js"></script>
  <script>
    const { initPage, requestJSON, showJSON, bindAction, statusBadge } = window.GoverShared;
    initPage({ active: "monitor" });

    function levelBadge(level) {
      const text = String(level || "").toUpperCase();
      if (text === "ERROR") return statusBadge("ERROR", "danger");
      if (text === "WARN") return statusBadge("WARN", "warning");
      return statusBadge("INFO", "info");
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function renderLogs(items) {
      const rows = Array.isArray(items) ? items : [];
      const body = document.querySelector("#monitorLogTable tbody");
      body.innerHTML = "";
      if (!rows.length) {
        document.getElementById("monitorLogEmpty").style.display = "";
        return;
      }
      document.getElementById("monitorLogEmpty").style.display = "none";
      for (const item of rows) {
        const tr = document.createElement("tr");
        const safeMessage = escapeHtml(item.message || "");
        tr.innerHTML = `
          <td>${levelBadge(item.level)}</td>
          <td>${escapeHtml(item.time || "")}</td>
          <td title="${safeMessage}">${safeMessage}</td>
        `;
        body.appendChild(tr);
      }
    }

    async function loadSetting() {
      const result = await requestJSON("/api/v1/monitor");
      const item = result.data || {};
      document.getElementById("isEnabled").value = item.isEnabled ? "true" : "false";
      document.getElementById("roomId").value = item.roomId || "";
      document.getElementById("roomUrl").value = item.roomUrl || "";
      document.getElementById("smtpServer").value = item.smtpServer || "";
      document.getElementById("smtpPort").value = item.smtpPort || 25;
      document.getElementById("mailAddress").value = item.mailAddress || "";
      document.getElementById("mailName").value = item.mailName || "";
      document.getElementById("password").value = item.password || "";
      document.getElementById("receivers").value = item.receivers || "";
      document.getElementById("smtpSsl").value = item.smtpSsl ? "true" : "false";
      document.getElementById("emailEnabled").value = item.isEnableEmailNotice ? "true" : "false";
      showJSON("box", result);
      return result;
    }

    async function loadStatusLogs() {
      const limit = Number(document.getElementById("statusLimit").value || 100);
      const level = encodeURIComponent(document.getElementById("statusLevel").value || "");
      const result = await requestJSON(`/api/v1/monitor/status?limit=${limit}&level=${level}`);
      renderLogs((result.data || {}).items || []);
      showJSON("box", result);
      return result;
    }

    bindAction("load", loadSetting, "box", { successToast: false });
    bindAction("saveRoom", async () => {
      const payload = {
        isEnabled: document.getElementById("isEnabled").value === "true",
        roomId: Number(document.getElementById("roomId").value || 0),
        roomUrl: document.getElementById("roomUrl").value || ""
      };
      const result = await requestJSON("/api/v1/monitor/room", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      showJSON("box", result);
      return result;
    }, "box");
    bindAction("saveEmail", async () => {
      const payload = {
        isEnableEmailNotice: document.getElementById("emailEnabled").value === "true",
        smtpServer: document.getElementById("smtpServer").value || "",
        smtpSsl: document.getElementById("smtpSsl").value === "true",
        smtpPort: Number(document.getElementById("smtpPort").value || 25),
        mailAddress: document.getElementById("mailAddress").value || "",
        mailName: document.getElementById("mailName").value || "",
        password: document.getElementById("password").value || "",
        receivers: document.getElementById("receivers").value || ""
      };
      const result = await requestJSON("/api/v1/monitor/email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      showJSON("box", result);
      return result;
    }, "box");
    bindAction("testEmail", async () => {
      const rawReceivers = (document.getElementById("receivers").value || "")
        .split(/[;,，；]/)
        .map((v) => v.trim())
        .filter((v) => v.length > 0);
      const payload = {
        subject: document.getElementById("testSubject").value || "",
        body: document.getElementById("testBody").value || "",
        receivers: rawReceivers
      };
      const result = await requestJSON("/api/v1/monitor/email/test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      showJSON("box", result);
      await loadStatusLogs();
      return result;
    }, "box");
    bindAction("status", loadStatusLogs, "box", { successToast: false });

    loadSetting().catch((error) => showJSON("box", { code: -1, message: error.message || String(error) }));
    loadStatusLogs().catch((error) => showJSON("box", { code: -1, message: error.message || String(error) }));
  </script>
</body>
</html>
